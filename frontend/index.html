<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trustworthy Model Registry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #0f172a;
      color: #e5e7eb;
    }
    body {
      margin: 0;
      padding: 1.5rem;
    }
    h1, h2, h3 {
      color: #f9fafb;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 1.5rem;
    }
    .card {
      background-color: #1f2937;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    input[type="text"],
    input[type="password"],
    input[type="file"],
    input[type="search"],
    select {
      width: 100%;
      margin-top: 0.25rem;
      padding: 0.35rem 0.5rem;
      border-radius: 0.4rem;
      border: 1px solid #4b5563;
      background: #111827;
      color: #f9fafb;
      font-size: 0.9rem;
    }
    input::file-selector-button {
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 0.4rem;
      margin-right: 0.5rem;
      background: #2563eb;
      color: white;
      cursor: pointer;
    }
    button {
      margin-top: 0.75rem;
      padding: 0.4rem 0.9rem;
      border-radius: 0.5rem;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      background: #2563eb;
      color: white;
    }
    button.secondary {
      background: #4b5563;
    }
    button.danger {
      background: #b91c1c;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #111827;
      border: 1px solid #4b5563;
    }
    .badge.sensitive {
      border-color: #f97316;
      color: #fed7aa;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.45rem 0.5rem;
      border-bottom: 1px solid #374151;
      text-align: left;
    }
    tr:hover {
      background: #111827;
    }
    .status {
      min-height: 1.4rem;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .status.ok {
      color: #22c55e;
    }
    .status.error {
      color: #f97316;
    }
    .pill {
      font-size: 0.8rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      border: 1px solid #4b5563;
    }
    .pill.logged-in {
      border-color: #22c55e;
      color: #bbf7d0;
    }
    .pill.logged-out {
      border-color: #9ca3af;
      color: #e5e7eb;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }
    @media (max-width: 800px) {
      .page {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="card" aria-label="Registry header">
    <div class="row" style="justify-content: space-between;">
      <div>
        <h1 style="margin: 0;">Trustworthy Model Registry</h1>
        <p style="margin: 0.2rem 0 0; font-size: 0.9rem; color: #9ca3af;">
          Upload, rate, and download models with access control and sensitivity tracking.
        </p>
      </div>
      <div>
        <span id="login-status-pill" class="pill logged-out">
          Logged out
        </span>
      </div>
    </div>
  </header>

  <main class="page">
    <!-- Left column: Auth + Upload -->
    <section aria-label="Authentication and upload">
      <!-- Auth card -->
      <section class="card" aria-labelledby="auth-title">
        <h2 id="auth-title">Authentication</h2>
        <p style="font-size: 0.85rem; color: #9ca3af;">
          Log in to get a token. All protected endpoints will use this token automatically.
        </p>

        <label for="username-input">Username</label>
        <input id="username-input" type="text" autocomplete="username" />

        <label for="password-input">Password</label>
        <input id="password-input" type="password" autocomplete="current-password" />

        <div class="row">
          <button id="login-button">Log in</button>
          <button id="logout-button" class="secondary">Log out</button>
        </div>

        <p id="auth-status" class="status" aria-live="polite"></p>
      </section>

      <!-- Upload card -->
      <section class="card" aria-labelledby="upload-title">
        <h2 id="upload-title">Upload Model</h2>
        <p style="font-size: 0.85rem; color: #9ca3af;">
          Upload a zipped model package. Some roles may be required.
        </p>

        <label for="model-name-input">Model name</label>
        <input id="model-name-input" type="text" placeholder="e.g., mnist-cnn" />

        <label class="row" style="margin-top: 0.5rem;">
          <input id="model-sensitive-input" type="checkbox" />
          <span style="font-size: 0.85rem; margin-left: 0.25rem;">
            Mark this model as <strong>sensitive</strong> (frontend-only for now)
          </span>
        </label>

        <label for="model-file-input">Model package (.zip)</label>
        <input id="model-file-input" type="file" accept=".zip" />

        <button id="upload-button">Upload model</button>

        <p id="upload-status" class="status" aria-live="polite"></p>
      </section>
    </section>

    <!-- Right column: List + actions -->
    <section aria-label="Models list and actions">
      <section class="card" aria-labelledby="models-title">
        <div class="row" style="justify-content: space-between; align-items: flex-end;">
          <div>
            <h2 id="models-title" style="margin-bottom: 0.25rem;">Models</h2>
            <p style="font-size: 0.85rem; color: #9ca3af; margin: 0;">
              Search, list, and download models from the registry.
            </p>
          </div>
          <div class="row">
            <label for="search-input" style="margin-top: 0;">
              <span class="sr-only">Search by name or regex</span>
              <input id="search-input" type="search" placeholder="Search models…" />
            </label>
            <button id="refresh-button" class="secondary">Refresh</button>
          </div>
        </div>

        <p id="models-status" class="status" aria-live="polite"></p>

        <div style="max-height: 400px; overflow-y: auto; margin-top: 0.25rem;">
          <table aria-label="Model list">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Sensitive</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="models-tbody">
              <!-- Rows inserted by JS -->
            </tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <script>
    // --- CONFIG ---
    const API_BASE_URL = "https://2047fz40z1.execute-api.us-east-1.amazonaws.com";

    const $ = (id) => document.getElementById(id);

    const loginStatusPill = $("login-status-pill");
    const authStatus = $("auth-status");
    const uploadStatus = $("upload-status");
    const modelsStatus = $("models-status");
    const modelsTbody = $("models-tbody");

    function setStatus(el, msg, type = "") {
      el.textContent = msg || "";
      el.classList.remove("ok", "error");
      if (type) el.classList.add(type);
    }

    // --- Token management ---
    function getToken() {
      return window.localStorage.getItem("tmr_token") || "";
    }

    function setToken(token, username) {
      if (token) {
        window.localStorage.setItem("tmr_token", token);
        window.localStorage.setItem("tmr_username", username || "");
        loginStatusPill.textContent = `Logged in as ${username || "user"}`;
        loginStatusPill.classList.remove("logged-out");
        loginStatusPill.classList.add("logged-in");
      } else {
        window.localStorage.removeItem("tmr_token");
        window.localStorage.removeItem("tmr_username");
        loginStatusPill.textContent = "Logged out";
        loginStatusPill.classList.remove("logged-in");
        loginStatusPill.classList.add("logged-out");
      }
    }

    function initAuthState() {
      const token = getToken();
      const username = window.localStorage.getItem("tmr_username") || "";
      if (token) {
        loginStatusPill.textContent = `Logged in as ${username || "user"}`;
        loginStatusPill.classList.add("logged-in");
        loginStatusPill.classList.remove("logged-out");
      } else {
        loginStatusPill.textContent = "Logged out";
        loginStatusPill.classList.remove("logged-in");
        loginStatusPill.classList.add("logged-out");
      }
    }

    // --- API wrapper ---
    async function apiFetch(path, options = {}) {
      const url = API_BASE_URL.replace(/\/$/, "") + path;

      // IMPORTANT: do NOT automatically add Content-Type or Authorization.
      // Let the browser choose defaults so the request stays "simple"
      // and avoids a CORS preflight.
      const headers = new Headers(options.headers || {});

      const resp = await fetch(url, {
        ...options,
        headers,
      });

      let data = null;
      const contentType = resp.headers.get("Content-Type") || "";
      if (contentType.includes("application/json")) {
        data = await resp.json().catch(() => null);
      } else {
        data = await resp.text().catch(() => null);
      }

      if (!resp.ok) {
        const errMsg =
          (data && data.detail) ||
          (typeof data === "string" ? data : "") ||
          `Request failed with status ${resp.status}`;
        throw new Error(errMsg);
      }

      return data;
    }

    // --- Auth handlers ---
    $("login-button").addEventListener("click", async () => {
      const username = $("username-input").value.trim();
      const password = $("password-input").value;

      if (!username || !password) {
        setStatus(authStatus, "Username and password required.", "error");
        return;
      }

      setStatus(authStatus, "Logging in…");
      try {
        // Backend: POST /api/v1/login?username=...&password=...
        const data = await apiFetch(
          `/api/v1/login?username=${encodeURIComponent(
            username
          )}&password=${encodeURIComponent(password)}`,
          {
            method: "POST",
          }
        );

        const token = data.token;
        if (!token) {
          throw new Error("No token returned from server.");
        }

        setToken(token, username);
        setStatus(authStatus, "Login successful.", "ok");
        loadModels();
      } catch (err) {
        console.error(err);
        setToken("", "");
        setStatus(authStatus, String(err.message || err), "error");
      }
    });

    $("logout-button").addEventListener("click", async () => {
      const token = getToken();
      if (!token) {
        setToken("", "");
        setStatus(authStatus, "Already logged out.", "ok");
        return;
      }

      setStatus(authStatus, "Logging out…");
      try {
        await apiFetch(
          `/api/v1/logout?token=${encodeURIComponent(token)}`,
          { method: "POST" }
        );
      } catch (err) {
        console.warn("Logout error:", err);
      }
      setToken("", "");
      setStatus(authStatus, "Logged out.", "ok");
    });

    // --- Upload handler ---
    $("upload-button").addEventListener("click", async () => {
      const name = $("model-name-input").value.trim();
      const fileInput = $("model-file-input");
      const isSensitive = $("model-sensitive-input").checked; // not used yet

      if (!getToken()) {
        setStatus(uploadStatus, "You must be logged in to upload.", "error");
        return;
      }
      if (!name) {
        setStatus(uploadStatus, "Model name is required.", "error");
        return;
      }
      if (!fileInput.files || fileInput.files.length === 0) {
        setStatus(uploadStatus, "Please choose a .zip file to upload.", "error");
        return;
      }

      const file = fileInput.files[0];
      setStatus(uploadStatus, "Uploading… this may take a bit.");

      try {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("model_id", name);
        formData.append("name", name);
        formData.append("description", "");
        formData.append("version", "1.0.0");

        const data = await apiFetch("/api/v1/models/upload", {
          method: "POST",
          body: formData,
          headers: {}, // let browser set multipart boundaries
        });

        setStatus(
          uploadStatus,
          `Upload succeeded. Model ID: ${data.model_id || name}`,
          "ok"
        );
        fileInput.value = "";
        $("model-name-input").value = "";
        $("model-sensitive-input").checked = false;

        loadModels();
      } catch (err) {
        console.error(err);
        setStatus(uploadStatus, String(err.message || err), "error");
      }
    });

    // --- Models list / search ---
    $("refresh-button").addEventListener("click", () => {
      loadModels();
    });

    $("search-input").addEventListener("input", () => {
      filterModels();
    });

    let cachedModels = [];

    function renderModels(models) {
      modelsTbody.innerHTML = "";
      if (!models || models.length === 0) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 4;
        cell.textContent = "No models found.";
        cell.style.color = "#9ca3af";
        row.appendChild(cell);
        modelsTbody.appendChild(row);
        return;
      }

      for (const m of models) {
        const tr = document.createElement("tr");

        const name =
          m.name || m.model_name || m.id || m.model_id || "(unnamed)";
        const type = m.type || "model";
        const isSensitive = false; // unknown for now

        const tdName = document.createElement("td");
        tdName.textContent = name;
        tr.appendChild(tdName);

        const tdType = document.createElement("td");
        tdType.textContent = type;
        tr.appendChild(tdType);

        const tdSens = document.createElement("td");
        const badge = document.createElement("span");
        badge.classList.add("badge");
        if (isSensitive) {
          badge.classList.add("sensitive");
          badge.textContent = "Sensitive";
        } else {
          badge.textContent = "Unknown";
        }
        tdSens.appendChild(badge);
        tr.appendChild(tdSens);

        const tdActions = document.createElement("td");
        const fullBtn = document.createElement("button");
        fullBtn.textContent = "Download";
        fullBtn.classList.add("secondary");
        fullBtn.addEventListener("click", () => {
          downloadModel(m);
        });
        tdActions.appendChild(fullBtn);

        tr.appendChild(tdActions);
        modelsTbody.appendChild(tr);
      }
    }

    function filterModels() {
      const q = $("search-input").value.trim().toLowerCase();
      if (!q) {
        renderModels(cachedModels);
        return;
      }
      const filtered = cachedModels.filter((m) => {
        const name =
          (m.name || m.model_name || m.id || m.model_id || "").toLowerCase();
        return name.includes(q);
      });
      renderModels(filtered);
    }

    async function loadModels() {
      setStatus(modelsStatus, "Loading models…");
      try {
        const data = await apiFetch("/api/v1/models?limit=50&skip=0", {
          method: "GET",
        });

        const models = data.models || [];
        cachedModels = models;
        renderModels(models);
        filterModels();
        setStatus(modelsStatus, `Loaded ${models.length} model(s).`, "ok");
      } catch (err) {
        console.error(err);
        setStatus(modelsStatus, String(err.message || err), "error");
        cachedModels = [];
        renderModels([]);
      }
    }

    // --- Download handler ---
    async function downloadModel(model) {
      const token = getToken();
      if (!token) {
        setStatus(modelsStatus, "You must be logged in to download.", "error");
        return;
      }

      const id =
        model.model_id || model.id || model.name || model.model_name || "model";

      setStatus(modelsStatus, `Preparing download for ${id}…`);

      try {
        const url =
          API_BASE_URL.replace(/\/$/, "") +
          `/api/v1/models/${encodeURIComponent(
            id
          )}/download?variant=full&token=${encodeURIComponent(token)}`;

        const resp = await fetch(url, { method: "GET" });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(
            `Download failed with status ${resp.status}: ${text.substring(
              0,
              200
            )}`
          );
        }

        const blob = await resp.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = downloadUrl;
        a.download = `${id}.zip`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(downloadUrl);

        setStatus(modelsStatus, `Download started for ${id}.`, "ok");
      } catch (err) {
        console.error(err);
        setStatus(modelsStatus, String(err.message || err), "error");
      }
    }

    // --- Init ---
    window.addEventListener("DOMContentLoaded", () => {
      initAuthState();
      loadModels();
    });
  </script>
</body>
</html>
